---
phase: 04-cost-reporting
plan: 01
type: execute
---

<objective>
Implement cost calculator service for tracking license costs of inactive mailboxes.

Purpose: Enable accurate cost analysis and reporting on inactive mailbox license consumption.
Output: Working cost calculator with license tracking, aggregation by multiple dimensions.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/data/models.py
@src/core/statistics_service.py

**From PROJECT.md:**
- Track license costs for inactive mailboxes
- Support multiple license types with configurable costs
- Aggregate by department, age, hold type, etc.
- Calculate potential savings from cleanup

**License cost assumptions:**
- Exchange Online Plan 1: ~$4/month
- Exchange Online Plan 2: ~$8/month
- Microsoft 365 E3: ~$36/month (Exchange portion ~$8)
- Microsoft 365 E5: ~$57/month (Exchange portion ~$12)
- Archive Add-on: ~$3/month

**Aggregation dimensions:**
1. By hold type (litigation, retention, eDiscovery)
2. By age bracket (0-90, 91-180, 181-365, 365+)
3. By department (from DisplayName parsing or AD attributes)
4. By mailbox size
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cost calculator data structures</name>
  <files>src/core/cost_calculator.py</files>
  <action>
    Create cost calculation framework:

    1. LicenseType enum:
       - EXCHANGE_ONLINE_P1
       - EXCHANGE_ONLINE_P2
       - M365_E3
       - M365_E5
       - ARCHIVE_ADDON

    2. LicenseCost dataclass:
       - license_type: LicenseType
       - monthly_cost: float
       - annual_cost: float
       - description: str

    3. MailboxCostInfo dataclass:
       - identity: str
       - display_name: str
       - license_type: LicenseType | None
       - monthly_cost: float
       - annual_cost: float
       - age_days: int
       - total_cost_to_date: float
       - size_mb: float
       - hold_types: list[str]
       - department: str | None

    4. CostSummary dataclass:
       - total_mailboxes: int
       - total_monthly_cost: float
       - total_annual_cost: float
       - by_license_type: dict[str, float]
       - by_hold_type: dict[str, float]
       - by_age_bracket: dict[str, float]
       - by_department: dict[str, float]
       - potential_savings: float

    5. Default license costs:
       ```python
       DEFAULT_LICENSE_COSTS = {
           LicenseType.EXCHANGE_ONLINE_P1: 4.00,
           LicenseType.EXCHANGE_ONLINE_P2: 8.00,
           LicenseType.M365_E3: 8.00,  # Exchange portion
           LicenseType.M365_E5: 12.00,
           LicenseType.ARCHIVE_ADDON: 3.00,
       }
       ```
  </action>
  <verify>python -c "from src.core.cost_calculator import LicenseType, LicenseCost, MailboxCostInfo; print('Cost data structures imported')"</verify>
  <done>Cost calculator data structures defined</done>
</task>

<task type="auto">
  <name>Task 2: Implement cost calculation logic</name>
  <files>src/core/cost_calculator.py (update)</files>
  <action>
    Create CostCalculator class:

    1. __init__(self, session: SessionManager, config: CostConfig | None = None)
       - Initialize with session and optional custom costs

    2. calculate_mailbox_cost(mailbox: InactiveMailbox) -> MailboxCostInfo
       - Calculate cost for single mailbox
       - Determine license type from mailbox properties
       - Calculate monthly/annual/total costs

    3. calculate_total_costs(mailboxes: list[InactiveMailbox]) -> CostSummary
       - Aggregate costs for multiple mailboxes
       - Group by license type, hold type, age, department

    4. calculate_potential_savings(mailboxes: list[InactiveMailbox]) -> float
       - Calculate savings if recovery-eligible mailboxes were processed
       - Only count mailboxes without legal holds

    5. get_cost_by_dimension(mailboxes, dimension: str) -> dict[str, float]
       - Aggregate by: "license_type", "hold_type", "age", "department", "size"

    6. estimate_annual_cost(monthly_cost: float) -> float
       - Simple annualization

    7. Helper methods:
       - _detect_license_type(mailbox) -> LicenseType
       - _extract_department(mailbox) -> str | None
       - _get_age_bracket(days: int) -> str
       - _get_size_bracket(size_mb: float) -> str
  </action>
  <verify>python -c "from src.core.cost_calculator import CostCalculator; print('CostCalculator imported')"</verify>
  <done>Cost calculation logic working</done>
</task>

<task type="auto">
  <name>Task 3: Add cost configuration and reporting</name>
  <files>src/core/cost_calculator.py (update), src/core/__init__.py</files>
  <action>
    Extend cost calculator with configuration and reporting:

    1. CostConfig dataclass:
       - license_costs: dict[LicenseType, float]
       - default_license_type: LicenseType
       - include_archive_costs: bool = True
       - currency_symbol: str = "$"
       - decimal_places: int = 2

    2. Add reporting methods:
       - generate_cost_report(mailboxes) -> CostReport
       - format_cost(amount: float) -> str
       - get_top_cost_mailboxes(mailboxes, limit: int = 10) -> list[MailboxCostInfo]

    3. CostReport dataclass:
       - generated_at: datetime
       - summary: CostSummary
       - top_cost_mailboxes: list[MailboxCostInfo]
       - recommendations: list[str]

    4. Add to src/core/__init__.py:
       - Export all cost calculator classes

    5. Generate recommendations based on analysis:
       - Identify high-cost mailboxes without legal holds
       - Flag long-inactive mailboxes (>2 years)
       - Suggest cleanup targets
  </action>
  <verify>python -c "from src.core import CostCalculator, CostConfig, CostReport; print('Cost exports working')"</verify>
  <done>Cost configuration and reporting complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] CostCalculator computes individual mailbox costs
- [ ] Aggregation by license type, hold type, age, department works
- [ ] Potential savings calculation is accurate
- [ ] Cost report generation includes recommendations
- [ ] Configurable license costs work
- [ ] All imports resolve
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Cost calculations are accurate
- Aggregations match expected groupings
- Recommendations are meaningful
</success_criteria>

<output>
After completion, create `.planning/phases/04-cost-reporting/04-01-SUMMARY.md`
</output>
