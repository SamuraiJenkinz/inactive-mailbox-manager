---
phase: 04-cost-reporting
plan: 02
type: execute
---

<objective>
Implement dashboard data service for preparing visualization data.

Purpose: Provide structured data for dashboards and charts in both terminal and desktop UIs.
Output: Working dashboard service with data aggregation for charts and metrics.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/04-cost-reporting/04-01-SUMMARY.md
@src/core/statistics_service.py
@src/core/cost_calculator.py

**Dashboard requirements:**
1. Executive summary metrics (total mailboxes, total cost, actionable items)
2. Cost breakdown charts (by license, hold type, age, department)
3. Trend data (if historical data available)
4. Top 10 lists (highest cost, oldest, largest)
5. Health indicators (% with holds, % recovery eligible)

**Chart data formats:**
- Pie/Donut: [{label: str, value: float, color: str}]
- Bar: [{category: str, value: float}]
- Line: [{x: date, y: float}]
- Table: [{columns...}]
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard data structures</name>
  <files>src/core/dashboard_service.py</files>
  <action>
    Create dashboard data framework:

    1. ChartType enum:
       - PIE
       - BAR
       - LINE
       - DONUT
       - TABLE

    2. ChartDataPoint dataclass:
       - label: str
       - value: float
       - color: str | None = None
       - percentage: float | None = None

    3. ChartData dataclass:
       - chart_type: ChartType
       - title: str
       - data_points: list[ChartDataPoint]
       - total: float | None = None
       - unit: str = ""  # "$", "GB", "count"

    4. MetricCard dataclass:
       - title: str
       - value: str
       - subtitle: str | None = None
       - trend: str | None = None  # "up", "down", "stable"
       - trend_value: str | None = None
       - color: str = "default"  # "success", "warning", "error"

    5. DashboardData dataclass:
       - generated_at: datetime
       - metrics: list[MetricCard]
       - charts: dict[str, ChartData]
       - top_lists: dict[str, list[dict]]
       - health_indicators: dict[str, float]
  </action>
  <verify>python -c "from src.core.dashboard_service import ChartType, ChartData, DashboardData; print('Dashboard data structures imported')"</verify>
  <done>Dashboard data structures defined</done>
</task>

<task type="auto">
  <name>Task 2: Implement dashboard service</name>
  <files>src/core/dashboard_service.py (update)</files>
  <action>
    Create DashboardService class:

    1. __init__(self, session: SessionManager)
       - Initialize with session for data access

    2. generate_dashboard() -> DashboardData
       - Orchestrate all data gathering
       - Return complete dashboard data

    3. get_executive_metrics() -> list[MetricCard]
       - Total inactive mailboxes
       - Total monthly cost
       - Recovery eligible count
       - Mailboxes with holds count

    4. get_cost_breakdown_chart() -> ChartData
       - Pie chart by license type

    5. get_hold_distribution_chart() -> ChartData
       - Donut chart by hold type

    6. get_age_distribution_chart() -> ChartData
       - Bar chart by age bracket

    7. get_size_distribution_chart() -> ChartData
       - Bar chart by size bracket

    8. get_top_cost_mailboxes(limit: int = 10) -> list[dict]
       - Top mailboxes by monthly cost

    9. get_oldest_mailboxes(limit: int = 10) -> list[dict]
       - Mailboxes by disconnected date

    10. get_largest_mailboxes(limit: int = 10) -> list[dict]
        - Mailboxes by size

    11. get_health_indicators() -> dict[str, float]
        - Percentage with holds
        - Percentage recovery eligible
        - Average age in days
        - Average size in MB
  </action>
  <verify>python -c "from src.core.dashboard_service import DashboardService; print('DashboardService imported')"</verify>
  <done>Dashboard service generating data</done>
</task>

<task type="auto">
  <name>Task 3: Add chart color schemes and formatting</name>
  <files>src/core/dashboard_service.py (update), src/core/__init__.py</files>
  <action>
    Add visualization helpers and exports:

    1. Color scheme constants:
       ```python
       CHART_COLORS = {
           "primary": ["#3498db", "#2ecc71", "#e74c3c", "#f39c12", "#9b59b6"],
           "cool": ["#1abc9c", "#3498db", "#9b59b6", "#34495e", "#7f8c8d"],
           "warm": ["#e74c3c", "#e67e22", "#f1c40f", "#d35400", "#c0392b"],
           "neutral": ["#2c3e50", "#7f8c8d", "#95a5a6", "#bdc3c7", "#ecf0f1"],
       }

       HOLD_TYPE_COLORS = {
           "Litigation": "#e74c3c",
           "eDiscovery": "#9b59b6",
           "Retention": "#3498db",
           "None": "#2ecc71",
       }

       STATUS_COLORS = {
           "success": "#2ecc71",
           "warning": "#f39c12",
           "error": "#e74c3c",
           "info": "#3498db",
       }
       ```

    2. Formatting helpers:
       - format_currency(value: float, symbol: str = "$") -> str
       - format_size(bytes: int) -> str
       - format_percentage(value: float) -> str
       - format_date(dt: datetime) -> str
       - format_duration(days: int) -> str

    3. Add to src/core/__init__.py:
       - Export DashboardService
       - Export DashboardData, ChartData, MetricCard
       - Export color schemes
  </action>
  <verify>python -c "from src.core import DashboardService, DashboardData, CHART_COLORS; print('Dashboard exports working')"</verify>
  <done>Dashboard service complete with formatting</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] DashboardService generates complete dashboard data
- [ ] Executive metrics are accurate
- [ ] Chart data is properly formatted
- [ ] Top lists return correct data
- [ ] Health indicators calculate correctly
- [ ] Color schemes are accessible
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Dashboard data is comprehensive
- Charts have consistent formatting
- Color schemes support accessibility
</success_criteria>

<output>
After completion, create `.planning/phases/04-cost-reporting/04-02-SUMMARY.md`
</output>
