---
phase: 04-cost-reporting
plan: 03
type: execute
---

<objective>
Implement advanced export manager for Excel, PDF, and enhanced CSV exports.

Purpose: Enable professional report generation for management and compliance.
Output: Working export manager with Excel workbooks, PDF reports, and styled CSV exports.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/04-cost-reporting/04-01-SUMMARY.md
@.planning/phases/04-cost-reporting/04-02-SUMMARY.md
@src/core/export_service.py

**Export requirements:**
1. Excel (.xlsx) with multiple sheets, charts, formatting
2. PDF reports with summary, tables, charts
3. Enhanced CSV with proper formatting
4. Scheduled/automated export support

**Excel sheets:**
- Summary: Executive overview with key metrics
- Mailboxes: Full inventory with cost data
- By Hold Type: Breakdown with subtotals
- By Department: Departmental analysis
- Cost Analysis: Monthly/annual projections

**PDF sections:**
- Cover page with date, tenant info
- Executive summary
- Cost analysis charts
- Detailed tables
- Recommendations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export data structures and base class</name>
  <files>src/core/report_generator.py</files>
  <action>
    Create report generation framework:

    1. ReportFormat enum:
       - EXCEL
       - PDF
       - CSV
       - JSON

    2. ReportType enum:
       - FULL_INVENTORY
       - COST_SUMMARY
       - HOLD_ANALYSIS
       - EXECUTIVE_SUMMARY
       - AUDIT_LOG

    3. ReportConfig dataclass:
       - format: ReportFormat
       - report_type: ReportType
       - include_charts: bool = True
       - include_recommendations: bool = True
       - date_range: tuple[datetime, datetime] | None = None
       - filters: dict[str, Any] | None = None

    4. ReportMetadata dataclass:
       - title: str
       - generated_at: datetime
       - generated_by: str
       - tenant_id: str | None
       - record_count: int
       - filters_applied: dict[str, Any]

    5. ReportResult dataclass:
       - success: bool
       - file_path: Path | None
       - metadata: ReportMetadata
       - error: str | None
       - file_size_bytes: int = 0
  </action>
  <verify>python -c "from src.core.report_generator import ReportFormat, ReportType, ReportConfig; print('Report structures imported')"</verify>
  <done>Report data structures defined</done>
</task>

<task type="auto">
  <name>Task 2: Implement Excel report generator</name>
  <files>src/core/report_generator.py (update)</files>
  <action>
    Create Excel generation using openpyxl:

    1. ExcelReportGenerator class:
       - __init__(self, session: SessionManager)
       - generate_full_report(path: Path, config: ReportConfig) -> ReportResult
       - generate_cost_report(path: Path) -> ReportResult
       - generate_inventory_report(path: Path) -> ReportResult

    2. Sheet generators:
       - _create_summary_sheet(wb: Workbook) -> Worksheet
       - _create_mailbox_sheet(wb: Workbook, mailboxes: list) -> Worksheet
       - _create_hold_analysis_sheet(wb: Workbook) -> Worksheet
       - _create_cost_sheet(wb: Workbook) -> Worksheet

    3. Formatting helpers:
       - _apply_header_style(ws: Worksheet, row: int)
       - _apply_currency_format(ws: Worksheet, column: str)
       - _apply_date_format(ws: Worksheet, column: str)
       - _add_autofilter(ws: Worksheet)
       - _adjust_column_widths(ws: Worksheet)

    4. Chart creation:
       - _add_pie_chart(ws: Worksheet, data_range: str, title: str)
       - _add_bar_chart(ws: Worksheet, data_range: str, title: str)

    5. Excel features:
       - Multiple worksheets
       - Formatted headers
       - Number formatting (currency, percentage)
       - Auto-filter on data tables
       - Conditional formatting for costs
       - Simple charts (if openpyxl.chart available)
  </action>
  <verify>python -c "from src.core.report_generator import ExcelReportGenerator; print('ExcelReportGenerator imported')"</verify>
  <done>Excel report generator working</done>
</task>

<task type="auto">
  <name>Task 3: Implement PDF and unified report manager</name>
  <files>src/core/report_generator.py (update), src/core/__init__.py</files>
  <action>
    Create PDF generator and unified manager:

    1. PDFReportGenerator class (using reportlab or fpdf):
       - generate_executive_summary(path: Path) -> ReportResult
       - generate_full_report(path: Path) -> ReportResult

    2. PDF sections:
       - _create_cover_page(canvas, metadata: ReportMetadata)
       - _create_summary_section(canvas, summary: CostSummary)
       - _create_table_section(canvas, data: list[dict])
       - _create_recommendations_section(canvas, recommendations: list[str])

    3. ReportManager class (unified interface):
       - __init__(self, session: SessionManager)
       - generate_report(config: ReportConfig, output_path: Path) -> ReportResult
       - schedule_report(config: ReportConfig, schedule: str) -> str
       - list_generated_reports() -> list[ReportMetadata]

    4. Format routing:
       - EXCEL -> ExcelReportGenerator
       - PDF -> PDFReportGenerator
       - CSV -> ExportService (existing)
       - JSON -> ExportService (existing)

    5. Add to src/core/__init__.py:
       - Export ReportManager, ReportConfig, ReportResult
       - Export all report-related classes
  </action>
  <verify>python -c "from src.core import ReportManager, ReportConfig, ReportResult; print('Report exports working')"</verify>
  <done>Report generation complete with all formats</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Excel reports generate with multiple sheets
- [ ] Excel formatting is professional
- [ ] PDF reports include all sections
- [ ] ReportManager routes to correct generator
- [ ] All exports include proper metadata
- [ ] Error handling for missing libraries
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Excel reports are well-formatted
- PDF reports are readable
- Unified interface works for all formats
</success_criteria>

<output>
After completion, create `.planning/phases/04-cost-reporting/04-03-SUMMARY.md`

**Phase 4 Complete Checklist:**
- [ ] Cost calculator with license tracking
- [ ] Dashboard data service
- [ ] Excel report generation
- [ ] PDF report generation
- [ ] Unified report manager
</output>
