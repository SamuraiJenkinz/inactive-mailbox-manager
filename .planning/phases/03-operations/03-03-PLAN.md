---
phase: 03-operations
plan: 03
type: execute
---

<objective>
Implement bulk operations manager for handling multiple mailbox operations from CSV.

Purpose: Enable efficient batch processing of recovery and restore operations.
Output: Working bulk operations manager with CSV import, progress tracking, and error handling.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-operations/03-01-SUMMARY.md
@.planning/phases/03-operations/03-02-SUMMARY.md

**From PROJECT.md:**
- Bulk operations handle 100+ mailboxes with real-time progress tracking
- CSV workflows for bulk operations
- Full audit trail for compliance

**Bulk operation types:**
1. Bulk Recovery: Recover multiple inactive mailboxes to new active mailboxes
2. Bulk Restore: Restore multiple inactive mailboxes to existing mailboxes
3. Bulk Export: Export details for multiple mailboxes
4. Bulk Validation: Validate multiple mailboxes for recovery eligibility

**CSV format for bulk recovery:**
```csv
source_guid,target_upn,target_smtp,display_name,first_name,last_name,department
abc-123,john.doe@domain.com,john.doe@domain.com,John Doe,John,Doe,IT
```

**From config:**
- bulk_operations.batch_size: 10
- bulk_operations.parallel_execution: false
- bulk_operations.stop_on_error: false
- bulk_operations.retry_failed: true
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bulk operation data structures</name>
  <files>src/core/bulk_operations.py</files>
  <action>
    Create bulk operation framework:

    1. BulkOperationType enum:
       - RECOVERY
       - RESTORE
       - VALIDATE
       - EXPORT

    2. BulkOperationItem dataclass:
       - row_number: int
       - source_identity: str
       - target_identity: str | None
       - additional_data: dict[str, Any]
       - status: str (pending, in_progress, completed, failed, skipped)
       - result: Any | None
       - error: str | None
       - started_at: datetime | None
       - completed_at: datetime | None

    3. BulkOperationResult dataclass:
       - operation_id: str
       - operation_type: BulkOperationType
       - total_items: int
       - completed_items: int
       - failed_items: int
       - skipped_items: int
       - items: list[BulkOperationItem]
       - started_at: datetime
       - completed_at: datetime | None
       - duration_seconds: float
       - success_rate: float

    4. BulkOperationConfig dataclass:
       - batch_size: int = 10
       - parallel_execution: bool = False
       - stop_on_error: bool = False
       - retry_failed: bool = True
       - max_retries: int = 3
       - delay_between_batches: float = 1.0

    5. CSV column mappings:
       ```python
       RECOVERY_COLUMNS = {
           "source_guid": "source_identity",
           "target_upn": "target_identity",
           "target_smtp": "target_smtp",
           "display_name": "display_name",
           "first_name": "first_name",
           "last_name": "last_name",
           "department": "department",
       }
       ```
  </action>
  <verify>python -c "from src.core.bulk_operations import BulkOperationType, BulkOperationItem, BulkOperationResult; print('Bulk operation types imported')"</verify>
  <done>Bulk operation data structures defined</done>
</task>

<task type="auto">
  <name>Task 2: Create CSV import/export for bulk operations</name>
  <files>src/core/bulk_operations.py (update)</files>
  <action>
    Add CSV handling for bulk operations:

    1. BulkCSVHandler class:
       - __init__(self)
       - import_recovery_csv(path: Path) -> list[BulkOperationItem]
       - import_restore_csv(path: Path) -> list[BulkOperationItem]
       - export_results_csv(result: BulkOperationResult, path: Path) -> None
       - validate_csv_format(path: Path, operation_type: BulkOperationType) -> list[str]
       - generate_template(operation_type: BulkOperationType, path: Path) -> None

    2. CSV validation:
       - Check required columns exist
       - Validate GUID format for source_identity
       - Validate email format for UPN/SMTP
       - Check for duplicate entries
       - Report row numbers with errors

    3. Recovery CSV columns (required*):
       - source_guid* (or source_identity)
       - target_upn*
       - target_smtp (defaults to target_upn)
       - display_name*
       - first_name
       - last_name
       - department
       - company

    4. Restore CSV columns (required*):
       - source_guid*
       - target_mailbox* (GUID or UPN)
       - target_folder
       - conflict_resolution

    5. Results CSV columns:
       - row_number
       - source_identity
       - target_identity
       - status
       - error
       - started_at
       - completed_at
       - duration_seconds
  </action>
  <verify>python -c "from src.core.bulk_operations import BulkCSVHandler; print('BulkCSVHandler imported')"</verify>
  <done>CSV import/export works for bulk operations</done>
</task>

<task type="auto">
  <name>Task 3: Create bulk operation executor</name>
  <files>src/core/bulk_operations.py (update)</files>
  <action>
    Create bulk operation execution engine:

    1. BulkOperationManager class:
       - __init__(self, session: SessionManager, config: BulkOperationConfig | None = None)
       - execute_bulk_recovery(items: list[BulkOperationItem], progress_callback: Callable | None = None) -> BulkOperationResult
       - execute_bulk_restore(items: list[BulkOperationItem], progress_callback: Callable | None = None) -> BulkOperationResult
       - execute_bulk_validation(items: list[BulkOperationItem], progress_callback: Callable | None = None) -> BulkOperationResult
       - cancel_operation(operation_id: str) -> bool
       - get_operation_status(operation_id: str) -> BulkOperationResult | None
       - retry_failed(result: BulkOperationResult) -> BulkOperationResult

    2. Execution flow:
       ```python
       def execute_bulk_recovery(self, items, callback):
           result = BulkOperationResult(...)

           for batch in self._batch_items(items):
               for item in batch:
                   item.status = "in_progress"
                   try:
                       recovery_result = self._recovery_service.recover_mailbox(...)
                       item.status = "completed" if recovery_result.success else "failed"
                       item.result = recovery_result
                   except Exception as e:
                       item.status = "failed"
                       item.error = str(e)

                   if callback:
                       callback(result)

               # Delay between batches
               time.sleep(self._config.delay_between_batches)

           return result
       ```

    3. Progress callback:
       - Called after each item completes
       - Provides current BulkOperationResult
       - UI can update progress bar, item list

    4. Error handling:
       - stop_on_error: Stop entire batch on first error
       - retry_failed: Retry failed items after batch completes
       - Log all errors to audit trail

    5. Audit logging:
       - Log bulk operation start with item count
       - Log each item result
       - Log bulk operation complete with summary
  </action>
  <verify>python -c "from src.core.bulk_operations import BulkOperationManager; print('BulkOperationManager imported')"</verify>
  <done>Bulk operation executor handles batches with progress tracking</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] BulkOperationManager executes recovery batches
- [ ] CSV import validates and parses correctly
- [ ] Progress callback updates during execution
- [ ] Results CSV exported with all details
- [ ] Error handling follows config settings
- [ ] Audit trail captures bulk operations
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- CSV import handles edge cases
- Progress tracking is accurate
- Bulk recovery executes correctly
- Results include all item details
</success_criteria>

<output>
After completion, create `.planning/phases/03-operations/03-03-SUMMARY.md`

**Phase 3 Complete Checklist:**
- [ ] Pre-flight validation detects all blockers
- [ ] Recovery wizard provides guided flow
- [ ] Restore operations with conflict handling
- [ ] Progress tracking for all operations
- [ ] Bulk operations with CSV import/export
- [ ] Full audit trail
</output>
